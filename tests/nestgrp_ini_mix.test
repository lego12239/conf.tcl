lappend auto_path [pwd]/../
package require tcltest
package require conf

proc cb-1.0 {_conf _ctx op kname kval} {
	upvar #0 $_conf conf

	switch $op {
	=S -
	=L {
		dict set conf {*}$kname $kval
	}
	+=S {
		if {[dict exists $conf {*}$kname]} {
			set val [dict get $conf {*}$kname]
		} else {
			set val ""
		}
		append val $kval
		dict set conf {*}$kname $val
	}
	+=L {
		if {[dict exists $conf {*}$kname]} {
			set val [dict get $conf {*}$kname]
		} else {
			set val ""
		}
		lappend val {*}$kval
		dict set conf {*}$kname $val
	}
	"SECT_CH" -
	F {
	}
	}
}

tcltest::test mix-1.0 {
	mix
} -body {
	set ::conf ""
	conf::load_from_str {cb-1.0 ::conf} "
	k=v
	\[a.b\]
	k1=v1
	l1.l2 \{
	  k2=v2
	  \[c.d\]
	  k3=v3
	  l3.l4 \{
	    k4=v4
	  \}
	  k5=v5
	\}
	k6=v6"
	return $::conf
} -result {k v a.b {k1 v1} l1.l2 {k2 v2 c.d {k3 v3} l3.l4 {k4 v4} k5 v5} k6 v6}

tcltest::test mix-2.0 {
	mix
} -body {
	set ::conf ""
	conf::load_from_str -hd . {cb-1.0 ::conf} "
	k=v
	\[a.b\]
	k1=v1
	l1.l2 \{
	  k2=v2
	  \[c.d\]
	  k3=v3
	  l3.l4 \{
	    k4=v4
	  \}
	  k5=v5
	\}
	k6=v6"
	return $::conf
} -result {k v a {b {k1 v1}} l1 {l2 {k2 v2 c {d {k3 v3}} l3 {l4 {k4 v4}} k5 v5}} k6 v6}

tcltest::test mix-3.0 {
	mix
} -body {
	set ::conf ""
	conf::load_from_str -hd . {cb-1.0 ::conf} "
	k=v
	\[a.b\]
	k1=v1
	\[a.c\]
	k2=v2
	\[d.e\]
	k3=v3
	l1.l2 \{
	  k4=v4
	  \[f.g\]
	  k5=v5
	  \[f.h\]
	  k6=v6
	  \[i.j\]
	  k7=v7
	  l3.l4 \{
	    k8=v8
	  \}
	  k9=v9
	\}
	k10=v10"
	return $::conf
} -result {k v a {b {k1 v1} c {k2 v2}} d {e {k3 v3}} l1 {l2 {k4 v4 f {g {k5 v5} h {k6 v6}} i {j {k7 v7}} l3 {l4 {k8 v8}} k9 v9}} k10 v10}

tcltest::cleanupTests

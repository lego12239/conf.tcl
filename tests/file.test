lappend auto_path [pwd]/../
package require tcltest
package require conf

tcltest::test file-1.0 {
	read conf from a missing file
} -body {
	conf::load_from_file cb-2.0 non-existent.conf
} -returnCodes error -result "couldn't open \"non-existent.conf\": no such file or directory"

proc cb-2.0 {_conf _ctx op kname kval} {
	upvar #0 $_conf conf

	if {($op ne "SECT_CH") && ($op ne "FILE")} {
		dict set conf {*}$kname $kval
	}
}

tcltest::test file-2.0 {
	read conf from a file
} -body {
	set ::conf ""
	conf::load_from_file -hd . {cb-2.0 ::conf} test.conf
	return $::conf
} -result {k v g1 {k1 {1 2 {3 4}} k2 {test 2 3} g2 {g3 {k3 v3}} k4 v4} k5 v5}

tcltest::test file-3.0 {
	read conf from a file handler
} -body {
	set ::conf ""
	set fh [open test.conf]
	conf::load_from_fh -hd . {cb-2.0 ::conf} $fh
	close $fh
	return $::conf
} -result {k v g1 {k1 {1 2 {3 4}} k2 {test 2 3} g2 {g3 {k3 v3}} k4 v4} k5 v5}

tcltest::test file-4.0 {
	read conf from a file with include statement
} -body {
	set ::conf ""
	conf::load_from_file -hd . {cb-2.0 ::conf} test_incl.1.conf
	return $::conf
} -result {k2 v2 k5 v5 k v}

tcltest::test file-4.1 {
	read conf from a file with include statement (with subsection)
} -body {
	set ::conf ""
	conf::load_from_file -hd . {cb-2.0 ::conf} test_incl.2.conf
	return $::conf
} -result {k v g1 {k2 v2 g1 {k3 v3} k5 v55} k5 v5}

tcltest::test file-4.2 {
	read conf from a file with nested include statements (with subsection)
} -body {
	set ::conf ""
	conf::load_from_file -hd . {cb-2.0 ::conf} test_incl.3.conf
	return $::conf
} -result {k v g1 {k2 v2 g1 {k3 v3 k2 v22 g1 {k3 v3} k4 v4} k5 v55} k5 v5}

tcltest::test file-4.3 {
	read conf from a file with nested include statements (with subsection) and -path
} -body {
	set ::conf ""
	conf::load_from_file -hd . -path incl {cb-2.0 ::conf} test_incl.5.conf
	return $::conf
} -result {k v g1 {k2 v2 g1 {k3 v3 k2 v22 g1 {k3 v3} k4 v4} k5 v55} k5 v5}

tcltest::test file-4.4 {
	read conf from a file with nested include statements (with subsection) and -path
} -body {
	set ::conf ""
	conf::load_from_file -hd . -path incl {cb-2.0 ::conf} test_incl.6.conf
	return $::conf
} -result {k v gg {p1 V1 p2 V2 p3 V3 p4 V4 p5 V5 s1 {p6 V6} p7 V7} k5 v5}

proc cb-3.0 {_conf _ctx op kname kval} {
	upvar #0 $_conf conf

	switch $op {
	=S {
		dict set conf data {*}$kname $kval
	}
	FILE {
		dict lappend conf files $kname
		if {$kname eq "incl/test_incl.5.1.conf"} {
			dict set conf got 1
			if {[dict get $conf data k] ne "v"} {
				error "k must be equal to v"
			}
			if {[dict exists $conf data g1 k2]} {
				error "k2 has not yet been defined"
			}
		}
	}
	}
}

tcltest::test file-5.0 {
	FILE cb op
} -body {
	set ::conf ""
	conf::load_from_file -hd . -path incl {cb-3.0 ::conf} test_incl.5.conf
	if {![dict exists $::conf got]} {
		error "Can't got a file"
	}
	return [dict get $::conf files]
} -result {incl/test_incl.5.1.conf incl/test_incl.5.2.conf}

proc cb-3.1 {_conf _ctx op kname kval} {
	upvar #0 $_conf conf

	switch $op {
	=S {
		dict set conf data {*}$kname $kval
	}
	FILE {
		dict lappend conf files $kname
	}
	}
}

tcltest::test file-5.1 {
	FILE cb op
} -body {
	set ::conf ""
	conf::load_from_file -hd . -path incl {cb-3.1 ::conf} test_incl.6.conf
	return [dict get $::conf files]
} -result {incl/test_incl.6.1.conf incl/test_incl.6.2.conf incl/test_incl.6.3.conf}


tcltest::cleanupTests

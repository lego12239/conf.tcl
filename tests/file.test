lappend auto_path [pwd]/../
package require tcltest
package require conf

tcltest::test file-1.0 {
	read conf from a missing file
} -body {
	conf::load_from_file non-existent.conf
} -returnCodes error -result "couldn't open \"non-existent.conf\": no such file or directory"

tcltest::test file-2.0 {
	read conf from a file
} -body {
	conf::load_from_file -hd . test.conf
} -result {k v g1 {k1 {1 2 {3 4}} k2 {test 2 3} g2 {g3 {k3 v3}} k4 v4} k5 v5}

tcltest::test file-2.1 {
	read conf from a file (-default_conf)
} -body {
	conf::load_from_file -hd . -default_conf "k5 = def kdef = vdef" test.conf
} -result {k5 v5 kdef vdef k v g1 {k1 {1 2 {3 4}} k2 {test 2 3} g2 {g3 {k3 v3}} k4 v4}}

tcltest::test file-3.0 {
	read conf from a file handler
} -body {
	set fh [open test.conf]
	set conf [conf::load_from_fh -hd . $fh]
	close $fh
	return $conf
} -result {k v g1 {k1 {1 2 {3 4}} k2 {test 2 3} g2 {g3 {k3 v3}} k4 v4} k5 v5}

tcltest::test file-3.1 {
	read conf from a file handler (-default_conf)
} -body {
	set fh [open test.conf]
	set conf [conf::load_from_fh -hd . -default_conf "k5 = def kdef = vdef" $fh]
	close $fh
	return $conf
} -result {k5 v5 kdef vdef k v g1 {k1 {1 2 {3 4}} k2 {test 2 3} g2 {g3 {k3 v3}} k4 v4}}

tcltest::test file-4.0 {
	read conf from a file with include statement
} -body {
	set conf [conf::load_from_file -hd . test_incl.1.conf]
	return $conf
} -result {k2 v2 k5 v5 k v}

tcltest::test file-4.1 {
	read conf from a file with include statement (with subsection)
} -body {
	set conf [conf::load_from_file -hd . test_incl.2.conf]
	return $conf
} -result {k v g1 {k2 v2 g1 {k3 v3} k5 v55} k5 v5}

tcltest::test file-4.2 {
	read conf from a file with nested include statements (with subsection)
} -body {
	set conf [conf::load_from_file -hd . test_incl.3.conf]
	return $conf
} -result {k v g1 {k2 v2 g1 {k3 v3 k2 v22 g1 {k3 v3} k4 v4} k5 v55} k5 v5}

tcltest::cleanupTests

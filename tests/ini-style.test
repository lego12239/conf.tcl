lappend auto_path [pwd]/../
package require tcltest
package require conf

proc cb-1.0 {_conf _ctx op kname kval} {
	upvar #0 $_conf conf

	if {$op ne "SECT_CH"} {
		dict set conf {*}$kname $kval
	}
}

tcltest::test ini-1.0 {
	parameter without a group
} -body {
	set ::conf ""
	conf::load_from_str {cb-1.0 ::conf} "k=v"
	return $::conf
} -result {k v}

tcltest::test ini-2.0 {
	parameter without a group and with a group
} -body {
	set ::conf ""
	conf::load_from_str {cb-1.0 ::conf} "k=v
	\[grp.one\]
	k=v"
	return $::conf
} -result {k v grp.one {k v}}

tcltest::test ini-2.1 {
	parameter without a group and with a group
} -body {
	set ::conf ""
	conf::load_from_str {cb-1.0 ::conf} "k=v
	\[grp.one\]
	k1=v1"
	return $::conf
} -result {k v grp.one {k1 v1}}

tcltest::test ini-2.2 {
	parameter without a group and with a group
} -body {
	set ::conf ""
	conf::load_from_str {cb-1.0 ::conf} "k=v
	k1=v1
	\[grp.one\]
	k2=v2
	k3=v3
	\[grp-two\]
	k4=v4"
	return $::conf
} -result {k v k1 v1 grp.one {k2 v2 k3 v3} grp-two {k4 v4}}

tcltest::test ini-3.0 {
	parameter without a group and with a group(with hd)
} -body {
	set ::conf ""
	conf::load_from_str -hd / {cb-1.0 ::conf} "k=v
	k1=v1
	\[grp.one\]
	k2=v2
	k3=v3
	\[grp-two\]
	k4=v4"
	return $::conf
} -result {k v k1 v1 grp.one {k2 v2 k3 v3} grp-two {k4 v4}}

tcltest::test ini-3.1 {
	parameter without a group and with a group(with hd)
} -body {
	set ::conf ""
	conf::load_from_str -hd . {cb-1.0 ::conf} "k=v
	k1=v1
	\[grp.one\]
	k2=v2
	k3=v3
	\[grp-two\]
	k4=v4"
	return $::conf
} -result {k v k1 v1 grp {one {k2 v2 k3 v3}} grp-two {k4 v4}}

tcltest::test ini-3.2 {
	parameter without a group and with a group(with hd)
} -body {
	set ::conf ""
	conf::load_from_str -hd . {cb-1.0 ::conf} "k=v
	grp.one.k1=vv
	\[grp.one\]
	k2=v2
	k3.g=v3
	\[grp-two\]
	k4.q=v4"
	return $::conf
} -result {k v grp {one {k1 vv k2 v2 k3 {g v3}}} grp-two {k4 {q v4}}}

tcltest::test ini-4.0 {
	parameter without a group and with a group(with hd)
} -body {
	set ::conf ""
	conf::load_from_str -hd . {cb-1.0 ::conf} "k=v
	a.b.k1=v1
	\[a.b.c.d\]
	k2=v2
	e.k3=v3
	\[a.b.c\]
	k4=v4
	\[a\]
	k5=v5
	\[a.b.c.d\]
	k6=v6"
	return $::conf
} -result {k v a {b {k1 v1 c {d {k2 v2 e {k3 v3} k6 v6} k4 v4}} k5 v5}}

tcltest::cleanupTests
